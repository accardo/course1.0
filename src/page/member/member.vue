<template>
   <div id="container">
       <v-title>{{ pageTitle }}</v-title>
       <div class="member justify">
           <div class="top box">
	           	<router-link to="/myInfo">
	               	<div class="avar">
	                   <img v-if="avar && avar != 'null'" :src="avar" />
	                   <img v-if="!avar || avar == 'null'" src="../../../static/img/default.png" />
	               	</div>
	               	<div class="name">
                     <p v-if="lineUserName != 'null'">{{ lineUserName }}</p>
                     <p v-if="lineUserName == 'null'">{{ nickName }}</p>
                        <div class="not">课程会员</div>
	               	</div>
	           </router-link>
           </div>
           <div class="login-out" @click="loginOutShow = true">登出</div>
           <!--<div class="contract box" v-show="isHaveContract">
           		<router-link to="/contract">
               		<p>{{ contractEndTime | formatDate }}到期</p>
               		<span class="icon-arrow icon-icon_contract_left rotate"></span>
           		</router-link>
           </div>-->
       </div>
       <!--<reserveList></reserveList>-->
       <div class="swiper-box">
           <swiper-banner :swipelist="swipeList" :param = "bannerParam"></swiper-banner>
       </div>
      <!-- <div class="colList">
           <ul>
              <li>
	               	<router-link to="/notice">
	                   <img src="../../../static/img/xiaoxi.png" alt="" />
	                   <p> 消息通知 </p>
	                   <div class="right">
	                       <span class="num" v-show="unreadCount">{{ unreadCount }} </span>
	                       <span class="icon icon-icon_contract_left rotate"></span>
	                   </div>
	                </router-link>
               </li>
               <li>
                   <img src="../../../static/img/kechng.png" alt="" />
                   <p>我的预约</p>
               </li>
           </ul>
       </div>-->
       <!--<listLay :coursefrom="1" :listData="listData" v-if="listData.length"></listLay>-->
       <div class="make-appointment">
           <h4>我得预约</h4>
           <div class="make-list">
               <class-list :list-data="listData" :list-type="listType"></class-list>
           </div>
       </div>
       <div class="popNotWrap">
           <img src="../../../static/img/not_1.png" alt="" />
           <p>还没有预约过课程，快去瞅瞅吧</p>
       </div>
       <login-out :login-out-show.sync="loginOutShow" v-if="loginOutShow"></login-out>
       <footerLay v-bind:position="position"></footerLay>
   </div>
</template>

<script>
    import footerLay from '@/components/footer'
    import common from '@/components/common'
    import listLay from '../home/list'
    // import reserveList from './reserveList'
    import VTitle from '@/components/title'
    import swiperBanner from '@/components/swiper'
    import classList from '@/components/classlist'
    import loginOut from '@/components/loginOut'

    export default {
        data () {
            return {
                pageTitle: '个人中心',
                uid: '',
                avar: '',
                phone: '',
                nickName: '',
                lineUserName: '',
                unreadCount: '',
                currentPage: 1,
                isHaveContract: '',
                loginOutShow: false,
                endListen: false,
                position:2,
                contractEndTime: '', // 到期日期
                bannerParam:{           //banner swiper 配置
                    auto:false,
                    swiperId:'aboutbanner',
                    showText:false,
                    delay:5000,
                    switchOpen: 2,
                },
                swipeList: [
                    {
                        title: '日日煮精选套餐',
                        date: '2018-12-23',
                        num: 8,
                    },
                    {
                        title: '日日煮精',
                        date: '2018-11-23',
                        num: 5,
                    },
                    {
                        title: '日日煮精选套餐日日煮精选套餐日日煮精选套餐',
                        date: '2018-8-21',
                        num: 4,
                    }
                ],
                listType: 2, // 2 -> mermber页面
                listData: []
            }
        },
        created () {
            this.initUserInfo();
            this.getContPackage();
            // let isMember = this.$store.state.isMember || localStorage.getItem('isMember')
            // if(isMember == true || isMember == 'true'){
            //     this.initUserInfo()
            // }else{
            //     this.$router.push('/notMember')
            // }
        },
        components: {
        	listLay,
        	common,
        	VTitle,
        	// reserveList,
        	footerLay,
            swiperBanner,
            classList,
            loginOut
        },
        methods: {
            /**
             * Description: 获取到期日期
             * Author: yanlichen <lichen.yan@daydaycook.com>
             * Date: 2018/5/16
             */
            getPersonalResList() {
                let phone = localStorage.getItem('phone');
                let infoUrl = `/daydaycook/server/offline/reservationUser/personalResList.do?mobile=${phone}`;
                return new Promise((resolve) => {
                    this.ajaxDataFun('post', infoUrl, (obj) => {
                        if(obj.code == '200'){
                            return resolve(obj);
                        }
                    });
                });
            },
        	initUserInfo(){
                this.getPersonalResList().then((res) => {
                    if (res.code == '200') {
                        this.listData = res.data;
                        console.log(res);
                    }
                })
        		/*this.avar = this.$store.state.avar || localStorage.getItem('avar')
                this.uid = this.$store.state.uid || localStorage.getItem('uid')
        		this.phone = this.$store.state.phone || localStorage.getItem('phone')
        		this.lineUserName = this.$store.state.lineUserName || localStorage.getItem('lineUserName')
        		this.nickName = this.$store.state.nickName || localStorage.getItem('nickName')
        		this.getList()  //获取我的课程列表
        		this.getInfoNum()  //获取消息数量
                this.getDateEnd().then((data) => { // 获取到期日期
                    if (data.code == '200') {
                        this.contractEndTime = data.userContract.contractEndTime;
                    }
                });*/
        	},
            /*
             * Description: 套餐合同
             * Author: yanlichen <lichen.yan@daydaycook.com.cn>
             * Date: 2018/8/22
             */
            getContPackage() {
                let packageUrl = `/daydaycook/server/newCourse/getContractPackageInfoByUid.do?uid=${this.uid}`;
                this.ajaxDataFun('get', packageUrl, (obj) => {
                    if(obj.code==200){
                        console.log(obj, '合同套餐')
                    }
                })
            },
        	getInfoNum:function(){
        		var _this = this
        		var _infoNumUrl = '/daydaycook/server/offline/record/unreadCount.do?userPhone=' + this.phone + '&uid=' + this.uid
        		this.ajaxDataFun('post', _infoNumUrl, function(obj){
        		    if(obj.code==200){
        		        _this.unreadCount = obj.data.unreadCount
                        _this.isHaveContract = obj.data.isHaveContract
                        _this.$nextTick(() => {
                          	window.scrollTo(0, 1)
                          	window.scrollTo(0, 0)
                        })
        		    }
        		})
        	},
        	getList:function(scroll){  //获取课程列表
                var _this = this
                var _listUrl = '/daydaycook/server/offline/reservationUser/offlineCourseList.do?type=2&mobile=' + this.phone + '&pageSize=5&currentPage=' + this.currentPage + '&uid=' + this.uid
                console.log(_listUrl, '获取课程列表');
                this.ajaxDataFun('post', _listUrl, function(obj){
                    if(obj.code == '200'){
                        if(scroll){
                            var objLen = obj.data.list.length;
                            if(objLen){
                                for(let j=0; j < objLen; j++){
                                    _this.listData.push(obj.data.list[j]);
                                }
                                _this.$set(_this.$data, 'listData', _this.listData);
                            }else{
                                _this.endListen = true
                                _this.$store.state.loadingTxt = ''
                            }
                        }else{
                            _this.categoryCount = obj.data.categoryCount
                            _this.listData = obj.data.list
                        }
                    }
                })
            },
        },
        mounted (){
          /*  var _this = this
            document.body.className = ''
            window.onscroll = function(){
            	let t = common.getScrollTop()
            	let h = common.getWindowHeight()
            	let s = common.getScrollHeight()

            　　if(t + h == s){
                    if(!_this.endListen){
                        _this.currentPage++
                        _this.getList(1)
                    }
                    console.log(_this.currentPage)
            　　}
            }*/
        },
        watch:{
       /* 	listData:function(){
                let l = this.listData
                let e = document.querySelector('.popNotWrap')
                if(l == 0){
                    e.classList.add('show')
                }else{
                  	e.classList.remove('show')
                }
            }*/
        }
    }
</script>
<style scoped>
    .member {
        background: url("../../../static/img/grzx_pic_bg.jpg") no-repeat;
        background-size: cover;
    }
    .member .top .name .not {
        font-size: 16px;
        opacity: 1;
    }
    .member .top .name p {
        margin-bottom: 0;
    }
    .make-appointment {
        margin: 20px;
    }
    .make-appointment h4{
        padding: 16px 0 14px 0;
        font-size: 22px;
        color: #1a1a1a;
        font-weight: 100;
    }
    .make-list {

    }
    .login-out {
        width: 68px;
        height: 26px;
        background: rgba(255,255,255,0.3);
        display: inline-block;
        font-size: 14px;
        color: #fff;
        text-align: center;
        box-shadow: 0 1px 10px 0 rgba(0,0,0,0.05);
        border-radius: 100px;
        line-height: 26px;
        margin-right: 10px;
        margin-bottom: 15px;
    }
</style>
